name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-structure:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking for required files..."
          test -f .claude-plugin/plugin.json || { echo "Missing plugin.json"; exit 1; }
          test -f README.md || { echo "Missing README.md"; exit 1; }
          test -f LICENSE || { echo "Missing LICENSE"; exit 1; }
          test -f CONTRIBUTING.md || { echo "Missing CONTRIBUTING.md"; exit 1; }
          test -f CODE_OF_CONDUCT.md || { echo "Missing CODE_OF_CONDUCT.md"; exit 1; }
          test -f SECURITY.md || { echo "Missing SECURITY.md"; exit 1; }
          echo "✓ All required files present"

      - name: Check directory structure
        run: |
          echo "Checking directory structure..."
          test -d commands || { echo "Missing commands directory"; exit 1; }
          test -d agents || { echo "Missing agents directory"; exit 1; }
          test -d tests || { echo "Missing tests directory"; exit 1; }
          test -d examples || { echo "Missing examples directory"; exit 1; }
          test -d .github || { echo "Missing .github directory"; exit 1; }
          echo "✓ All required directories present"

      - name: Validate plugin.json
        run: |
          echo "Validating plugin.json..."
          cat .claude-plugin/plugin.json | jq empty || { echo "Invalid JSON in plugin.json"; exit 1; }
          echo "✓ plugin.json is valid JSON"

  validate-commands:
    name: Validate Commands
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/validation/*.sh

      - name: Run command validation tests
        run: |
          echo "Running command validation tests..."
          ./tests/validation/test-commands.sh

      - name: Check command frontmatter
        run: |
          echo "Checking all commands have frontmatter..."
          for cmd in commands/**/*.md; do
            if ! grep -q "^---$" "$cmd"; then
              echo "Missing frontmatter in $cmd"
              exit 1
            fi
          done
          echo "✓ All commands have frontmatter"

      - name: Check command descriptions
        run: |
          echo "Checking all commands have descriptions..."
          for cmd in commands/**/*.md; do
            if ! grep -q "^description:" "$cmd"; then
              echo "Missing description in $cmd"
              exit 1
            fi
          done
          echo "✓ All commands have descriptions"

  validate-agents:
    name: Validate Agents
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make test scripts executable
        run: chmod +x tests/validation/*.sh

      - name: Run agent validation tests
        run: |
          echo "Running agent validation tests..."
          ./tests/validation/test-agents.sh

      - name: Check agent README files
        run: |
          echo "Checking agent category READMEs exist..."
          test -f agents/README.md || { echo "Missing agents/README.md"; exit 1; }
          test -f agents/codebase/README.md || { echo "Missing agents/codebase/README.md"; exit 1; }
          test -f agents/documentation/README.md || { echo "Missing agents/documentation/README.md"; exit 1; }
          test -f agents/web/README.md || { echo "Missing agents/web/README.md"; exit 1; }
          echo "✓ All agent README files present"

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "CI Bot"
          git config --global user.email "ci@example.com"

      - name: Make test scripts executable
        run: |
          chmod +x tests/integration/workflows/*.sh
          chmod +x tests/integration/agents/*.sh
          chmod +x tests/integration/examples/*.sh

      - name: Run workflow integration tests
        run: |
          echo "Running workflow integration tests..."
          for test in tests/integration/workflows/test-*.sh; do
            echo "Running $test..."
            $test
          done

      - name: Run agent integration tests
        run: |
          echo "Running agent integration tests..."
          for test in tests/integration/agents/test-*.sh; do
            echo "Running $test..."
            $test
          done

      - name: Run example validation tests
        run: |
          echo "Running example validation tests..."
          for test in tests/integration/examples/test-*.sh; do
            echo "Running $test..."
            $test
          done

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .git || true
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint .github/ || true
        continue-on-error: true

  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check internal links in README
        run: |
          echo "Checking internal documentation links..."
          # Check that referenced files exist
          test -f USAGE.md || echo "Warning: README references missing USAGE.md"
          test -f CONFIGURATION.md || echo "Warning: README references missing CONFIGURATION.md"
          test -f CONTRIBUTING.md || echo "Warning: README references missing CONTRIBUTING.md"
          test -f CHANGELOG.md || echo "Warning: README references missing CHANGELOG.md"
          test -f LICENSE || echo "Warning: README references missing LICENSE"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-commands, validate-agents, integration-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.validate-structure.result }}" != "success" ] || \
             [ "${{ needs.validate-commands.result }}" != "success" ] || \
             [ "${{ needs.validate-agents.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi
